"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Display class
 */
const os = require("os");
const errorHandler_1 = require("unitejs-framework/dist/helpers/errorHandler");
const defaultLogger_1 = require("unitejs-framework/dist/loggers/defaultLogger");
class DisplayLogger {
    constructor(process, noColor) {
        this._colorsOn = this.calculateColors(process, noColor);
        this._colors = {
            reset: { start: 0, stop: 0 },
            bold: { start: 1, stop: 22 },
            dim: { start: 2, stop: 22 },
            italic: { start: 3, stop: 23 },
            underline: { start: 4, stop: 24 },
            inverse: { start: 7, stop: 27 },
            hidden: { start: 8, stop: 28 },
            strikethrough: { start: 9, stop: 29 },
            black: { start: 30, stop: 39 },
            red: { start: 31, stop: 39 },
            green: { start: 32, stop: 39 },
            yellow: { start: 33, stop: 39 },
            blue: { start: 34, stop: 39 },
            magenta: { start: 35, stop: 39 },
            cyan: { start: 36, stop: 39 },
            white: { start: 37, stop: 39 },
            gray: { start: 90, stop: 39 },
            grey: { start: 90, stop: 39 },
            bgBlack: { start: 40, stop: 49 },
            bgRed: { start: 41, stop: 49 },
            bgGreen: { start: 42, stop: 49 },
            bgYellow: { start: 43, stop: 49 },
            bgBlue: { start: 44, stop: 49 },
            bgMagenta: { start: 45, stop: 49 },
            bgCyan: { start: 46, stop: 49 },
            bgWhite: { start: 47, stop: 49 }
        };
    }
    banner(message, args) {
        this.display("green", "white", message, args);
    }
    info(message, args) {
        this.display("white", "cyan", message, args);
    }
    warning(message, args) {
        this.display("yellow", "cyan", message, args);
    }
    error(message, err, args) {
        let finalMessage;
        if (message !== null && message !== undefined && message.length > 0) {
            finalMessage = `ERROR: ${message}`;
        }
        else {
            finalMessage = "ERROR";
        }
        this.display("red", "red", finalMessage, args);
        if (err) {
            defaultLogger_1.DefaultLogger.log(`${this.colorStart("red")}${errorHandler_1.ErrorHandler.format(err)}${this.colorStop("red")}`);
        }
    }
    display(messageColor, argsColor, message, args) {
        if (args && Object.keys(args).length > 0) {
            if (message !== null && message !== undefined && message.length > 0) {
                defaultLogger_1.DefaultLogger.log(`${this.colorStart(messageColor)}${message}: ${this.colorStop(messageColor)}${this.colorStart(argsColor)}${this.arrayToReadable(args)}${this.colorStop(argsColor)}`);
            }
            else {
                defaultLogger_1.DefaultLogger.log(`${this.colorStart(argsColor)}${this.arrayToReadable(args).trim()}${this.colorStop(argsColor)}`);
            }
        }
        else {
            if (message !== null && message !== undefined && message.length > 0) {
                defaultLogger_1.DefaultLogger.log(`${this.colorStart(messageColor)}${message}${this.colorStop(argsColor)}`);
            }
            else {
                defaultLogger_1.DefaultLogger.log("");
            }
        }
    }
    colorStart(color) {
        return this._colorsOn ? `\u001b[${this._colors[color].start}m` : "";
    }
    colorStop(color) {
        return this._colorsOn ? `\u001b[${this._colors[color].stop}m` : "";
    }
    arrayToReadable(args) {
        const retParts = [];
        const objKeys = Object.keys(args);
        if (objKeys.length === 1) {
            if (args[objKeys[0]] !== undefined && args[objKeys[0]] !== null) {
                retParts.push(args[objKeys[0]].toString());
            }
            else {
                retParts.push("undefined");
            }
        }
        else {
            objKeys.forEach(objKey => {
                retParts.push(os.EOL);
                retParts.push(`\t${objKey}: `);
                if (args[objKey] !== undefined && args[objKey] !== null) {
                    retParts.push(args[objKey].toString());
                }
                else {
                    retParts.push("undefined");
                }
            });
        }
        return retParts.join("");
    }
    calculateColors(process, noColor) {
        // Logic copied from https://github.com/chalk/supports-color/blob/master/index.js
        if (noColor) {
            return false;
        }
        if (process) {
            if (process.stdout && !process.stdout.isTTY) {
                return false;
            }
            if (process.platform === "win32") {
                return true;
            }
            if (process.env) {
                if ("CI" in process.env) {
                    return ["TRAVIS", "CIRCLECI", "APPVEYOR", "GITLAB_CI"].some(sign => sign in process.env);
                }
                if ("TEAMCITY_VERSION" in process.env) {
                    return /^(9\.(0*[1-9]\d*)\.|\d{2,}\.)/.test(process.env.TEAMCITY_VERSION);
                }
                if ("TERM_PROGRAM" in process.env) {
                    if (["iTerm.app", "Hyper", "Apple_Terminal"].indexOf(process.env.TERM_PROGRAM) >= 0) {
                        return true;
                    }
                }
                if (/^(screen|xterm)-256(?:color)?/.test(process.env.TERM)) {
                    return true;
                }
                if (/^screen|^xterm|^vt100|color|ansi|cygwin|linux/i.test(process.env.TERM)) {
                    return true;
                }
                if ("COLORTERM" in process.env) {
                    return true;
                }
                if (process.env.TERM === "dumb") {
                    return false;
                }
            }
        }
        return false;
    }
}
exports.DisplayLogger = DisplayLogger;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kaXNwbGF5TG9nZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7O0dBRUc7QUFDSCx5QkFBeUI7QUFDekIsOEVBQTJFO0FBRTNFLGdGQUE2RTtBQUU3RTtJQUlJLFlBQVksT0FBdUIsRUFBRSxPQUFnQjtRQUNqRCxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3hELElBQUksQ0FBQyxPQUFPLEdBQUc7WUFDWCxLQUFLLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUU7WUFFNUIsSUFBSSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO1lBQzVCLEdBQUcsRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtZQUMzQixNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUU7WUFDOUIsU0FBUyxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO1lBQ2pDLE9BQU8sRUFBRSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtZQUMvQixNQUFNLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUU7WUFDOUIsYUFBYSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFO1lBRXJDLEtBQUssRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtZQUM5QixHQUFHLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBRSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUU7WUFDNUIsS0FBSyxFQUFFLEVBQUUsS0FBSyxFQUFFLEVB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T0FBTyxFQUFFLGdCQUFnQixDQUFDLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFO3dCQUNqRixPQUFPLElBQUksQ0FBQztxQkFDZjtpQkFDSjtnQkFFRCxJQUFJLCtCQUErQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUN4RCxPQUFPLElBQUksQ0FBQztpQkFDZjtnQkFFRCxJQUFJLGdEQUFnRCxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUN6RSxPQUFPLElBQUksQ0FBQztpQkFDZjtnQkFFRCxJQUFJLFdBQVcsSUFBSSxPQUFPLENBQUMsR0FBRyxFQUFFO29CQUM1QixPQUFPLElBQUksQ0FBQztpQkFDZjtnQkFFRCxJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxLQUFLLE1BQU0sRUFBRTtvQkFDN0IsT0FBTyxLQUFLLENBQUM7aUJBQ2hCO2FBQ0o7U0FDSjtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQWpLRCxzQ0FpS0MiLCJmaWxlIjoiZGlzcGxheUxvZ2dlci5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRGlzcGxheSBjbGFzc1xuICovXG5pbXBvcnQgKiBhcyBvcyBmcm9tIFwib3NcIjtcbmltcG9ydCB7IEVycm9ySGFuZGxlciB9IGZyb20gXCJ1bml0ZWpzLWZyYW1ld29yay9kaXN0L2hlbHBlcnMvZXJyb3JIYW5kbGVyXCI7XG5pbXBvcnQgeyBJTG9nZ2VyIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvaW50ZXJmYWNlcy9JTG9nZ2VyXCI7XG5pbXBvcnQgeyBEZWZhdWx0TG9nZ2VyIH0gZnJvbSBcInVuaXRlanMtZnJhbWV3b3JrL2Rpc3QvbG9nZ2Vycy9kZWZhdWx0TG9nZ2VyXCI7XG5cbmV4cG9ydCBjbGFzcyBEaXNwbGF5TG9nZ2VyIGltcGxlbWVudHMgSUxvZ2dlciB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBfY29sb3JzT246IGJvb2xlYW47XG4gICAgcHJpdmF0ZSByZWFkb25seSBfY29sb3JzOiB7IFtpZDogc3RyaW5nXTogeyBzdGFydDogbnVtYmVyOyBzdG9wOiBudW1iZXIgfSB9O1xuXG4gICAgY29uc3RydWN0b3IocHJvY2VzczogTm9kZUpTLlByb2Nlc3MsIG5vQ29sb3I6IGJvb2xlYW4pIHtcbiAgICAgICAgdGhpcy5fY29sb3JzT24gPSB0aGlzLmNhbGN1bGF0ZUNvbG9ycyhwcm9jZXNzLCBub0NvbG9yKTtcbiAgICAgICAgdGhpcy5fY29sb3JzID0ge1xuICAgICAgICAgICAgcmVzZXQ6IHsgc3RhcnQ6IDAsIHN0b3A6IDAgfSxcblxuICAgICAgICAgICAgYm9sZDogeyBzdGFydDogMSwgc3RvcDogMjIgfSxcbiAgICAgICAgICAgIGRpbTogeyBzdGFydDogMiwgc3RvcDogMjIgfSxcbiAgICAgICAgICAgIGl0YWxpYzogeyBzdGFydDogMywgc3RvcDogMjMgfSxcbiAgICAgICAgICAgIHVuZGVybGluZTogeyBzdGFydDogNCwgc3RvcDogMjQgfSxcbiAgICAgICAgICAgIGludmVyc2U6IHsgc3RhcnQ6IDcsIHN0b3A6IDI3IH0sXG4gICAgICAgICAgICBoaWRkZW46IHsgc3RhcnQ6IDgsIHN0b3A6IDI4IH0sXG4gICAgICAgICAgICBzdHJpa2V0aHJvdWdoOiB7IHN0YXJ0OiA5LCBzdG9wOiAyOSB9LFxuXG4gICAgICAgICAgICBibGFjazogeyBzdGFydDogMzAsIHN0b3A6IDM5IH0sXG4gICAgICAgICAgICByZWQ6IHsgc3RhcnQ6IDMxLCBzdG9wOiAzOSB9LFxuICAgICAgICAgICAgZ3JlZW46IHsgc3RhcnQ6IDMyLCBzdG9wOiAzOSB9LFxuICAgICAgICAgICAgeWVsbG93OiB7IHN0YXJ0OiAzMywgc3RvcDogMzkgfSxcbiAgICAgICAgICAgIGJsdWU6IHsgc3RhcnQ6IDM0LCBzdG9wOiAzOSB9LFxuICAgICAgICAgICAgbWFnZW50YTogeyBzdGFydDogMzUsIHN0b3A6IDM5IH0sXG4gICAgICAgICAgICBjeWFuOiB7IHN0YXJ0OiAzNiwgc3RvcDogMzkgfSxcbiAgICAgICAgICAgIHdoaXRlOiB7IHN0YXJ0OiAzNywgc3RvcDogMzkgfSxcbiAgICAgICAgICAgIGdyYXk6IHsgc3RhcnQ6IDkwLCBzdG9wOiAzOSB9LFxuICAgICAgICAgICAgZ3JleTogeyBzdGFydDogOTAsIHN0b3A6IDM5IH0sXG5cbiAgICAgICAgICAgIGJnQmxhY2s6IHsgc3RhcnQ6IDQwLCBzdG9wOiA0OSB9LFxuICAgICAgICAgICAgYmdSZWQ6IHsgc3RhcnQ6IDQxLCBzdG9wOiA0OSB9LFxuICAgICAgICAgICAgYmdHcmVlbjogeyBzdGFydDogNDIsIHN0b3A6IDQ5IH0sXG4gICAgICAgICAgICBiZ1llbGxvdzogeyBzdGFydDogNDMsIHN0b3A6IDQ5IH0sXG4gICAgICAgICAgICBiZ0JsdWU6IHsgc3RhcnQ6IDQ0LCBzdG9wOiA0OSB9LFxuICAgICAgICAgICAgYmdNYWdlbnRhOiB7IHN0YXJ0OiA0NSwgc3RvcDogNDkgfSxcbiAgICAgICAgICAgIGJnQ3lhbjogeyBzdGFydDogNDYsIHN0b3A6IDQ5IH0sXG4gICAgICAgICAgICBiZ1doaXRlOiB7IHN0YXJ0OiA0Nywgc3RvcDogNDkgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHB1YmxpYyBiYW5uZXIobWVzc2FnZTogc3RyaW5nLCBhcmdzPzogeyBbaWQ6IHN0cmluZ106IGFueSB9KTogdm9pZCB7XG4gICAgICAgIHRoaXMuZGlzcGxheShcImdyZWVuXCIsIFwid2hpdGVcIiwgbWVzc2FnZSwgYXJncyk7XG4gICAgfVxuXG4gICAgcHVibGljIGluZm8obWVzc2FnZTogc3RyaW5nLCBhcmdzPzogeyBbaWQ6IHN0cmluZ106IGFueSB9KTogdm9pZCB7XG4gICAgICAgIHRoaXMuZGlzcGxheShcIndoaXRlXCIsIFwiY3lhblwiLCBtZXNzYWdlLCBhcmdzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgd2FybmluZyhtZXNzYWdlOiBzdHJpbmcsIGFyZ3M/OiB7IFtpZDogc3RyaW5nXTogYW55IH0pOiB2b2lkIHtcbiAgICAgICAgdGhpcy5kaXNwbGF5KFwieWVsbG93XCIsIFwiY3lhblwiLCBtZXNzYWdlLCBhcmdzKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZXJyb3IobWVzc2FnZTogc3RyaW5nLCBlcnI/OiBhbnksIGFyZ3M/OiB7IFtpZDogc3RyaW5nXTogYW55IH0pOiB2b2lkIHtcbiAgICAgICAgbGV0IGZpbmFsTWVzc2FnZTtcbiAgICAgICAgaWYgKG1lc3NhZ2UgIT09IG51bGwgJiYgbWVzc2FnZSAhPT0gdW5kZWZpbmVkICYmIG1lc3NhZ2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgZmluYWxNZXNzYWdlID0gYEVSUk9SOiAke21lc3NhZ2V9YDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGZpbmFsTWVzc2FnZSA9IFwiRVJST1JcIjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRpc3BsYXkoXCJyZWRcIiwgXCJyZWRcIiwgZmluYWxNZXNzYWdlLCBhcmdzKTtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgICAgRGVmYXVsdExvZ2dlci5sb2coYCR7dGhpcy5jb2xvclN0YXJ0KFwicmVkXCIpfSR7RXJyb3JIYW5kbGVyLmZvcm1hdChlcnIpfSR7dGhpcy5jb2xvclN0b3AoXCJyZWRcIil9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRpc3BsYXkobWVzc2FnZUNvbG9yOiBzdHJpbmcsIGFyZ3NDb2xvcjogc3RyaW5nLCBtZXNzYWdlOiBzdHJpbmcsIGFyZ3M/OiB7IFtpZDogc3RyaW5nXTogYW55IH0pOiB2b2lkIHtcbiAgICAgICAgaWYgKGFyZ3MgJiYgT2JqZWN0LmtleXMoYXJncykubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2UgIT09IG51bGwgJiYgbWVzc2FnZSAhPT0gdW5kZWZpbmVkICYmIG1lc3NhZ2UubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIERlZmF1bHRMb2dnZXIubG9nKGAke3RoaXMuY29sb3JTdGFydChtZXNzYWdlQ29sb3IpfSR7bWVzc2FnZX06ICR7dGhpcy5jb2xvclN0b3AobWVzc2FnZUNvbG9yKX0ke3RoaXMuY29sb3JTdGFydChhcmdzQ29sb3IpfSR7dGhpcy5hcnJheVRvUmVhZGFibGUoYXJncyl9JHt0aGlzLmNvbG9yU3RvcChhcmdzQ29sb3IpfWApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBEZWZhdWx0TG9nZ2VyLmxvZyhgJHt0aGlzLmNvbG9yU3RhcnQoYXJnc0NvbG9yKX0ke3RoaXMuYXJyYXlUb1JlYWRhYmxlKGFyZ3MpLnRyaW0oKX0ke3RoaXMuY29sb3JTdG9wKGFyZ3NDb2xvcil9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAobWVzc2FnZSAhPT0gbnVsbCAmJiBtZXNzYWdlICE9PSB1bmRlZmluZWQgJiYgbWVzc2FnZS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgRGVmYXVsdExvZ2dlci5sb2coYCR7dGhpcy5jb2xvclN0YXJ0KG1lc3NhZ2VDb2xvcil9JHttZXNzYWdlfSR7dGhpcy5jb2xvclN0b3AoYXJnc0NvbG9yKX1gKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgRGVmYXVsdExvZ2dlci5sb2coXCJcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNvbG9yU3RhcnQoY29sb3I6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jb2xvcnNPbiA/IGBcXHUwMDFiWyR7dGhpcy5fY29sb3JzW2NvbG9yXS5zdGFydH1tYCA6IFwiXCI7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjb2xvclN0b3AoY29sb3I6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLl9jb2xvcnNPbiA/IGBcXHUwMDFiWyR7dGhpcy5fY29sb3JzW2NvbG9yXS5zdG9wfW1gIDogXCJcIjtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFycmF5VG9SZWFkYWJsZShhcmdzPzogeyBbaWQ6IHN0cmluZ106IGFueSB9KTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcmV0UGFydHM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IG9iaktleXMgPSBPYmplY3Qua2V5cyhhcmdzKTtcbiAgICAgICAgaWYgKG9iaktleXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICBpZiAoYXJnc1tvYmpLZXlzWzBdXSAhPT0gdW5kZWZpbmVkICYmIGFyZ3Nbb2JqS2V5c1swXV0gIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICByZXRQYXJ0cy5wdXNoKGFyZ3Nbb2JqS2V5c1swXV0udG9TdHJpbmcoKSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldFBhcnRzLnB1c2goXCJ1bmRlZmluZWRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBvYmpLZXlzLmZvckVhY2gob2JqS2V5ID0+IHtcbiAgICAgICAgICAgICAgICByZXRQYXJ0cy5wdXNoKG9zLkVPTCk7XG4gICAgICAgICAgICAgICAgcmV0UGFydHMucHVzaChgXFx0JHtvYmpLZXl9OiBgKTtcbiAgICAgICAgICAgICAgICBpZiAoYXJnc1tvYmpLZXldICE9PSB1bmRlZmluZWQgJiYgYXJnc1tvYmpLZXldICAhPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgICByZXRQYXJ0cy5wdXNoKGFyZ3Nbb2JqS2V5XS50b1N0cmluZygpKTtcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICByZXRQYXJ0cy5wdXNoKFwidW5kZWZpbmVkXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiByZXRQYXJ0cy5qb2luKFwiXCIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2FsY3VsYXRlQ29sb3JzKHByb2Nlc3M6IE5vZGVKUy5Qcm9jZXNzLCBub0NvbG9yOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgICAgIC8vIExvZ2ljIGNvcGllZCBmcm9tIGh0dHBzOi8vZ2l0aHViLmNvbS9jaGFsay9zdXBwb3J0cy1jb2xvci9ibG9iL21hc3Rlci9pbmRleC5qc1xuICAgICAgICBpZiAobm9Db2xvcikge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHByb2Nlc3MpIHtcbiAgICAgICAgICAgIGlmIChwcm9jZXNzLnN0ZG91dCAmJiAhcHJvY2Vzcy5zdGRvdXQuaXNUVFkpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSBcIndpbjMyXCIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHByb2Nlc3MuZW52KSB7XG4gICAgICAgICAgICAgICAgaWYgKFwiQ0lcIiBpbiBwcm9jZXNzLmVudikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gW1wiVFJBVklTXCIsIFwiQ0lSQ0xFQ0lcIiwgXCJBUFBWRVlPUlwiLCBcIkdJVExBQl9DSVwiXS5zb21lKHNpZ24gPT4gc2lnbiBpbiBwcm9jZXNzLmVudik7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKFwiVEVBTUNJVFlfVkVSU0lPTlwiIGluIHByb2Nlc3MuZW52KSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAvXig5XFwuKDAqWzEtOV1cXGQqKVxcLnxcXGR7Mix9XFwuKS8udGVzdChwcm9jZXNzLmVudi5URUFNQ0lUWV9WRVJTSU9OKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoXCJURVJNX1BST0dSQU1cIiBpbiBwcm9jZXNzLmVudikge1xuICAgICAgICAgICAgICAgICAgICBpZiAoW1wiaVRlcm0uYXBwXCIsIFwiSHlwZXJcIiwgXCJBcHBsZV9UZXJtaW5hbFwiXS5pbmRleE9mKHByb2Nlc3MuZW52LlRFUk1fUFJPR1JBTSkgPj0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoL14oc2NyZWVufHh0ZXJtKS0yNTYoPzpjb2xvcik/Ly50ZXN0KHByb2Nlc3MuZW52LlRFUk0pKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGlmICgvXnNjcmVlbnxeeHRlcm18XnZ0MTAwfGNvbG9yfGFuc2l8Y3lnd2lufGxpbnV4L2kudGVzdChwcm9jZXNzLmVudi5URVJNKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAoXCJDT0xPUlRFUk1cIiBpbiBwcm9jZXNzLmVudikge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBpZiAocHJvY2Vzcy5lbnYuVEVSTSA9PT0gXCJkdW1iXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG59XG4iXX0=
